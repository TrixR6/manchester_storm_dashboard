<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rundown View</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='styles.css') }}" rel="stylesheet">
</head>
<body class="light-mode">
    <nav class="navbar navbar-expand-lg navbar-dark">
        <a class="navbar-brand" href="#"><img src="https://upload.wikimedia.org/wikipedia/en/c/c7/ManchesterStorm.png" alt="Logo"></a>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="/">Dashboard</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" id="rundownDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Rundown
                    </a>
                    <div class="dropdown-menu" aria-labelledby="rundownDropdown">
                        <a class="dropdown-item" href="/rundown">View Rundown</a>
                        <a class="dropdown-item" href="/edit_rundown">Edit Rundown</a>
                        <a class="dropdown-item" href="/import_rundown">Import Rundown</a>
                    </div>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/roster">Rosters</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin">Admin Panel</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/events">Events Management</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" id="miscDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Misc
                    </a>
                    <div class="dropdown-menu" aria-labelledby="miscDropdown">
                        <a class="dropdown-item" href="https://www.manchesterstorm.com/" target="_blank">Manchester Storm Website</a>
                        <a class="dropdown-item" href="https://www.eliteleague.co.uk/" target="_blank">EIHL Website</a>
                        <a class="dropdown-item" href="https://hub.eihl.tv/users/sign_in" target="_blank">EIHL TV Hub</a>
                    </div>
                </li>
            </ul>
            <span class="navbar-text ml-auto">
                <input type="checkbox" id="darkModeToggle" title="Toggle dark mode">
                <label for="darkModeToggle">Dark Mode</label>
            </span>
            <span class="navbar-text ml-auto clock">
                <span id="currentStage">{{ state.current_stage.replace('_', ' ') }}</span> -
                <span id="datetime"></span>
            </span>
        </div>
    </nav>
    <div class="container">
        <h3 class="mt-4">Show Rundown</h3>
        <table id="rundownTable" class="table table-striped">
            <thead>
                <tr>
                    <th>Segment Number</th>
                    <th>Item Name</th>
                    <th>Start Time</th>
                    <th>Duration</th>
                    <th>Notes</th>
                    <th>Video</th>
                    <th>Graphics</th>
                    <th>Audio</th>
                    <th>Script</th>
                    <th>Talent</th>
                    <th>Color</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for segment in rundown %}
                <tr id="segment-{{ segment.number }}" class="{% if segment.number == state.current_segment %}current-segment{% endif %}" data-segment-id="{{ segment.number }}" style="background-color: {{ segment.color }};">
                    <td>{{ segment.number }}</td>
                    <td><span class="static">{{ segment.item_name }}</span><input type="text" class="form-control editable" value="{{ segment.item_name }}" name="item_name"></td>
                    <td><span class="static">{{ segment.start_time }}</span><input type="time" class="form-control editable" value="{{ segment.start_time }}" name="start_time"></td>
                    <td><span class="static">{{ segment.duration }}</span><input type="text" class="form-control editable" value="{{ segment.duration }}" name="duration"></td>
                    <td><span class="static">{{ segment.notes }}</span><input type="text" class="form-control editable" value="{{ segment.notes }}" name="notes"></td>
                    <td><span class="static">{{ segment.video }}</span><input type="text" class="form-control editable" value="{{ segment.video }}" name="video"></td>
                    <td><span class="static">{{ segment.graphics }}</span><input type="text" class="form-control editable" value="{{ segment.graphics }}" name="graphics"></td>
                    <td><span class="static">{{ segment.audio }}</span><input type="text" class="form-control editable" value="{{ segment.audio }}" name="audio"></td>
                    <td><span class="static">{{ segment.script }}</span><input type="text" class="form-control editable" value="{{ segment.script }}" name="script"></td>
                    <td><span class="static">{{ segment.talent }}</span><input type="text" class="form-control editable" value="{{ segment.talent }}" name="talent"></td>
                    <td><span class="static">{{ segment.color_name }}</span><input type="text" class="form-control editable" value="{{ segment.color_name }}" name="color_name"></td>
                    <td>
                        <button class="btn btn-primary btn-action edit-btn" onclick="editSegment(this)">Edit</button>
                        <button class="btn btn-success btn-action save-btn editable" onclick="saveSegment(this)" style="display:none;">Save</button>
                        <button class="btn btn-danger btn-action" onclick="deleteSegment({{ segment.number }})">Delete</button>
                        <button class="btn btn-secondary btn-action" onclick="setCurrentSegment({{ segment.number }})"
                            {% if segment.number == state.current_segment %} disabled {% endif %}>Set Current</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div class="mt-3">
        <a href="/export_rundown" class="btn btn-success">Export Rundown as JSON</a>
        <a href="/import_rundown" class="btn btn-primary">Import Rundown from JSON</a>
    </div>
    
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script>
        function toggleDarkMode() {
            const isDarkMode = document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('darkModeToggle').checked = true;
            }
            document.getElementById('darkModeToggle').addEventListener('change', toggleDarkMode);
        });

        function updateClock() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' };
            document.getElementById('datetime').innerText = now.toLocaleDateString('en-US', options).replace(' at ', ' - ');
        }

        $(function() {
            $("#rundownTable tbody").sortable({
                update: function(event, ui) {
                    var new_order = $(this).sortable('toArray', {attribute: 'data-segment-id'});
                    $.ajax({
                        url: '/reorder_rundown',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ new_order: new_order }),
                        success: function(response) {
                            location.reload();  // Reload the page to reflect changes
                        }
                    });
                }
            }).disableSelection();
        });

        function editSegment(button) {
            var row = $(button).closest('tr');
            row.find('.static').hide();
            row.find('.editable').show();
            row.find('.edit-btn').hide();
            row.find('.save-btn').show();
        }

        function saveSegment(button) {
            var row = $(button).closest('tr');
            var segmentNumber = row.data('segment-id');
            var segmentData = {
                item_name: row.find('input[name="item_name"]').val(),
                start_time: row.find('input[name="start_time"]').val(),
                duration: row.find('input[name="duration"]').val(),
                notes: row.find('input[name="notes"]').val(),
                video: row.find('input[name="video"]').val(),
                graphics: row.find('input[name="graphics"]').val(),
                audio: row.find('input[name="audio"]').val(),
                script: row.find('input[name="script"]').val(),
                talent: row.find('input[name="talent"]').val(),
                color_name: row.find('input[name="color_name"]').val()
            };
            $.ajax({
                url: `/edit_rundown_segment/${segmentNumber}`,
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(segmentData),
                success: function(response) {
                    location.reload();  // Reload the page to reflect changes
                },
                error: function(xhr, status, error) {
                    alert('Failed to save segment: ' + xhr.responseText);
                }
            });
        }

        function deleteSegment(segmentNumber) {
            if (confirm("Are you sure you want to delete this segment?")) {
                $.ajax({
                    url: `/delete_rundown_segment/${segmentNumber}`,
                    type: 'POST',
                    success: function(response) {
                        location.reload();  // Reload the page to reflect changes
                    },
                    error: function(xhr, status, error) {
                        alert('Failed to delete segment: ' + xhr.responseText);
                    }
                });
            }
        }

        function setCurrentSegment(segmentNumber) {
            $.ajax({
                url: `/set_current_segment/${segmentNumber}`,
                type: 'POST',
                success: function(response) {
                    location.reload();  // Reload the page to reflect changes
                },
                error: function(xhr, status, error) {
                    alert('Failed to set current segment: ' + xhr.responseText);
                }
            });
        }

        setInterval(updateClock, 1000);
        updateClock();
    </script>
</body>
</html>
